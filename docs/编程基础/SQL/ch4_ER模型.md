# ER 模型

ER模型全称为实体联系模型，真实的世界可以被建模为一系列实体的集合和这些实体之间的联系。

## 实体集 E

所谓的实体是一个具有属性的对象，可以理解为关系型数据库中的一行；一个实体集是多个同类实体的集合，可以理解为关系型数据库中的一张表。属性是可以被实体集成员拥有的可描述性质，属性具有域和类型，类型又包括：

* 简单(Simple)和复合(Composite)属性，比如sex只有male/female二选一，但是name有first name和last name两部分组成
* 单值(Single-valued)和多值(Multi-valued)属性，比如一个person只能有一个ID,但是可以有多个phone number
* 派生属性（derived attribute），比如年龄可以由出生日期计算得到

## 联系集 R

一个联系(relationship)是两个或者多个实体集之间的关联，比如每位研究生都有自己的导师；一个联系集是相同类型关系的集合，表示两个或者多个实体集之间的关联。更正式来说，一个联系集是多个实体集某些部分的集合：$\{(e_1,e_2,...,e_n)|e_1\in E_1,e_2\in E_2,...,e_n\in E_n\} $。

### 联系集的度

度(degree)表示一个联系集中包含的实体集的数量，比如一个联系集包含两个实体集，就叫做二元关系或者二元联系，当然联系集也有可能包含超过两个实体集，比如三元联系

### 映射基数

映射基数(mapping cardinalities)是指一个实体集可以与另一个实体集发生联系的实体数目，其中数目是指一个还是多个，在描述二元关系中非常有用，也就是一对一、一对多、多对一或者多对多

### 码/键

这里一般翻译做码，超码是可以唯一确定联系的属性集合，候选码是超码中属性数量最少的，主码是人为指定的超码。相关实体集中的主码组合在一起就构成了联系集中的主码，所以一对实体集最多有一个联系集。

在考虑主码时一定要考虑映射基数，因为只要不是多对多，就可以只选单的那边的实体集的主码来当联系集的主码。

## ER 图

矩形(Rectangle)表示实体集，中间用线段分开，上面表示实体集的名称，下面表示实体集的属性名，主码用下划线标注，菱形(Diamond)代表联系集，用线条连接实体集和联系集。

### 有属性的联系集

联系集也可以有自己的属性，在E-R图中通过未分割的矩形来表示，并用虚线与联系集相连

### 角色

实体在联系中发挥的功能称为实体的角色，同样的实体集以不同角色参加同一个联系，需要用角色名区分，比如在一门课程的先修课程是另一门课程，课程这个实体就以两种形式参与到了这个关系中

### 基数约束

有箭头的直线表示一，无箭头的直线表示多，限制了一个实体发生关联的另一个实体的数目上限，注意一定是一的那头打箭头。

### 参与约束

全参与(total participation)用双直线，部分参与(partial participation)用单直线。参与约束反应了一个实体关联数目的下限，是0次还是1次。

这个有另一种符号表示形式，比如`0...*`表示0个或者多个，`1..1`表示有且仅有一个

### 二元联系

二元联系比多元的要好表示，有些三元关系是可以拆成二元的，比如家长与孩子，你可以拆成父亲与孩子和母亲与孩子；对于本身就不是二元的联系，可以通过人为增加关系集拆成三个二元关系

## 弱实体集

一个没有主码的实体集被称作弱实体集，它必须依附于另一个实体集存在，比如我们定义一个课程与学期之间的联系，学期是完全依附于课程的，又比如银行账号是依赖于银行的，要先知道是哪家银行再查银行账号才有意义。

当然，理论上是可以把一家银行的所有银行号作为属性和银行存放在同一张表的，但是这样会有很多重复，我们要避免主键过长过复杂和尽量减少存储开销。

弱实体集没有超码的概念，只有个类似于超码的东西叫做分辨符(discriminator)或者部分码(partial key)，一个弱实体集的主码是由标识集的主码和弱实体集的分辨符共同构成。

弱实体集的标识符用虚下划线标注，标识联系集用双层菱形表示，弱实体集用双层矩形。

## 延伸ER特征

### 实体集的层

属性继承，是指低层的实体会继承上层所有关联实体的全部属性，类似于OOP里面的继承；与之相对的概念是泛化，是指的把相同的属性打包进同一个上层实体。继承与泛化是一体两面，可以相互转化描述。

### 层设计的限制

* 分层原因约束：向下分成不同的层的原因有两种，一种是按条件定义，比如只有本科在读才能被归入学生下面的本科生，另一种是用户定义，比如不同组的员工。
* 独立性约束：一个实体可以只属于一个低层的实体集，在ER图里面写一个`disj`，另一种情况是可以同时属于多个实体集
* 完整性约束：上层的实体是不是必须属于下层的某个实体

### 聚合

可以通过聚合避免重复，简单来说就是可以把一组有联系的实体集打包，再表示与其他实体集的关系

## 一些ER模型设计的思考

1. **用一个属性还是一个实体集去表示一个对象？**

用一个属性会比较简单，但是对于电话号码这种多重属性，多个号码集中在一个属性会破坏原子性，故还是要分作一个实体集。

2. **是作为一个实体集还是一个联系集？**

两个实体集之间发生的动作用一个联系集表示，但是这么做也有缺陷，前面说过两个实体之间只能有一个关系，这个在某些情况下是不正确的，比如一个人可以在同一个银行有多笔贷款，这种情况下贷款关系就不能作为联系集

3. **是作为实体集的属性还是联系集的属性？**

从对象数据独立性和减少数据冗余考虑

## 将ER模型转化为数据库表

ER模型终究只是一个概念上的东西，最终实现还是要在数据库中：

1. 把关系模型转化为一个表的形式
   1. 复合属性会被展开成一个个属性
   2. 多重属性会被处理成一个表

2. 表示弱实体集，把标识实体集的主键和弱实体集合并
3. 把联系集表示成表：把两个参与实体集合的主键并在一起表示，加上这个联系表自身的属性
4. 表的合并：
   1. 多对一的可以把一合并到多的表里面，如果多的那一侧是partial的，可以加null填补
   2. 联系弱实体集及其联系集是冗余的，也可以都合并到标识集里面
5. 用表表示特化：
   1. 可以在特化的表里面除了主键只保留上层没有的，缺点是信息不全，得多表查询
   2. 特化的表里面保留全部信息，如果是全特化，可以舍弃父表，把父表定义为一个视图，但其实显式的表可能还是需要被定义用于主键约束，缺点是信息可能会重复
